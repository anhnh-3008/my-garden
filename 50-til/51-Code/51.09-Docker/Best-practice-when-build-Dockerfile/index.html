<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="🌿 I. Chỉ định rõ version của Base Image 🌱 Bad FROM ruby ... 🌱 Good FROM ruby:3.1.2 ... Nên chỉ định rõ version để có thể tái sử dụng."><title>🥦 Best practice when build Dockerfile</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://anhhn.netlify.app//icon.png><link href=https://anhhn.netlify.app/styles.93122d67bf9382106f082efbc3cd23eb.min.css rel=stylesheet><link href=https://anhhn.netlify.app/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://anhhn.netlify.app/js/darkmode.183fcede5b91e00cd4379bf6fc1fe35f.min.js></script>
<script src=https://anhhn.netlify.app/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://anhhn.netlify.app/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://anhhn.netlify.app/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://anhhn.netlify.app/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://anhhn.netlify.app/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://anhhn.netlify.app/",fetchData=Promise.all([fetch("https://anhhn.netlify.app/indices/linkIndex.125459b3fcde3f13db6eae34e969b07f.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://anhhn.netlify.app/indices/contentIndex.ff774c68701f6e60431c058d072c9c38.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://anhhn.netlify.app",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://anhhn.netlify.app",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{"’":"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/anhhn.netlify.app\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-HDBMVFQGBH"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-HDBMVFQGBH",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://anhhn.netlify.app/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js></script><h1 id=page-title><a href=https://anhhn.netlify.app/>Home</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>🥦 Best practice when build Dockerfile</h1><p class=meta>Last updated
Jan 3, 2023
<a href=https://github.com/anhnh-3008/quartz/tree/hugo/content/50%20til/51%20Code/51.09%20Docker/Best%20practice%20when%20build%20Dockerfile.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://anhhn.netlify.app/tags/til/>Til</a></li><li><a href=https://anhhn.netlify.app/tags/docker/>Docker</a></li></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#-i-chỉ-định-rõ-version-của-base-image>🌿 I. Chỉ định rõ version của Base Image</a></li><li><a href=#-ii-chỉ-nên-sử-dụng-trusted-or-official-base-images>🌿 II. Chỉ nên sử dụng trusted or official base images</a></li><li><a href=#-iii-chỉ-định-rõ-version-của-dependencies>🌿 III. Chỉ định rõ version của dependencies</a></li><li><a href=#-iv-đưa-những-commands-ít-thay-đổi-lên-trước>🌿 IV. Đưa những commands ít thay đổi lên trước</a></li><li><a href=#-v-tránh-chạy-container-với-quyền-root>🌿 V. Tránh chạy container với quyền root</a></li><li><a href=#-vi-sử-dụng--chown-khi-run-copy-hoặc-add>🌿 VI. Sử dụng -chown khi run COPY hoặc ADD</a></li><li><a href=#-vii-tránh-làm-lộ-thông-tin-nhạy-cảm-trong-dockerfile>🌿 VII. Tránh làm lộ thông tin nhạy cảm trong Dockerfile</a></li><li><a href=#-viii-xóa-luôn-những-thông-tin-nhạy-cảm-sử-dụng-để-build>🌿 VIII. Xóa luôn những thông tin nhạy cảm sử dụng để build</a></li><li><a href=#-ix-tối-ưu-size-của-base-image-nếu-có-thể>🌿 IX. Tối ưu size của base image nếu có thể</a></li></ol></nav></details></aside><a href=#-i-chỉ-định-rõ-version-của-base-image><h2 id=-i-chỉ-định-rõ-version-của-base-image><span class=hanchor arialabel=Anchor># </span>🌿 I. Chỉ định rõ version của Base Image</h2></a><ul><li>🌱 Bad</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>...<span class=err>
</span></span></span></code></pre></div><ul><li>🌱 Good</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>...<span class=err>
</span></span></span></code></pre></div><ul><li>Nên chỉ định rõ version để có thể tái sử dụng. Cũng tiện theo dõi khi chúng ta muốn upgrade & maintain.</li></ul><a href=#-ii-chỉ-nên-sử-dụng-trusted-or-official-base-images><h2 id=-ii-chỉ-nên-sử-dụng-trusted-or-official-base-images><span class=hanchor arialabel=Anchor># </span>🌿 II. Chỉ nên sử dụng trusted or official base images</h2></a><ul><li>🌱 Bad</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> random-dude-on-the-internet/ruby:3.1.2</span><span class=err>
</span></span></span></code></pre></div><ul><li>🌱 Good</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># hoặc </span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> random-dude-on-the-internet/ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># giả sử chúng ta biết chắc rằng random-dude-on-the-internet uy tín/tín.</span><span class=err>
</span></span></span></code></pre></div><ul><li>Vì chúng ta không thể chắc rằng Base Image có được sửa đổi hay không. Với những nguồn không uy tín, nếu người viết không ghi change log rõ ràng có thể gây ảnh hưởng đến hệ thống.</li></ul><a href=#-iii-chỉ-định-rõ-version-của-dependencies><h2 id=-iii-chỉ-định-rõ-version-của-dependencies><span class=hanchor arialabel=Anchor># </span>🌿 III. Chỉ định rõ version của dependencies</h2></a><ul><li>🌱 Bad</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> gem install sinatra<span class=err>
</span></span></span></code></pre></div><ul><li>🌱 Good</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> gem install sinatra -v 2.0.5<span class=err>
</span></span></span></code></pre></div><ul><li>Tương tự như base image, chúng ta cũng nên chỉ định rõ version cho dependencies. Hầu hết các trình quản lý package như <code>Gemfile.lock</code>, <code>package-lock.json</code>, <code>yarn.lock</code> đều chỉ định rõ, dễ dàng quản lý, theo dõi cũng như thuận tiện tái sử dụng.</li></ul><a href=#-iv-đưa-những-commands-ít-thay-đổi-lên-trước><h2 id=-iv-đưa-những-commands-ít-thay-đổi-lên-trước><span class=hanchor arialabel=Anchor># </span>🌿 IV. Đưa những commands ít thay đổi lên trước</h2></a><ul><li>🌱 Bad</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Source code</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> my-code/ /srv/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Application dependencies</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> Gemfile Gemfile.lock ./<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> bundle install<span class=err>
</span></span></span></code></pre></div><ul><li>🌱 Good</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Application dependencies</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> Gemfile Gemfile.lock ./<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> bundle install<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Source code</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> my-code/ /srv/<span class=err>
</span></span></span></code></pre></div><ul><li>Docker sẽ build lại tuần tự từ trên xuống dưới, bắt đầu từ câu lệnh có &rsquo;thay đổi&rsquo;. Ví dụ như trên, source code sẽ được thay đổi thường xuyên hơn Gemfile, nếu đặt source code ở trên, Docker sẽ build lại cả phần <code>COPY</code> với <code>RUN bundle install</code> nữa.</li></ul><blockquote class=note-callout><p>Note</p><p>Đặt các lệnh ít có khả năng thay đổi nhất ở trên cùng để tận dụng cache, giảm thời gian build Image.</p></blockquote><a href=#-v-tránh-chạy-container-với-quyền-root><h2 id=-v-tránh-chạy-container-với-quyền-root><span class=hanchor arialabel=Anchor># </span>🌿 V. Tránh chạy container với quyền root</h2></a><ul><li>🌱 Bad</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> gem install sinatra -v 2.0.5<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nb>echo</span> <span class=s1>&#39;require &#34;sinatra&#34;; run Sinatra::Application.run!&#39;</span> &gt; config.ru<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># By default this is run as root</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> rackup<span class=err>
</span></span></span></code></pre></div><ul><li>🌱 Good</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> gem install sinatra -v 2.0.5<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Tạo user riêng để chạy container</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> adduser -D my-sinatra-user<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Chỉ định User thực hiện các câu lệnh RUN, CMD hoặc ENTRYPOINT ở dưới</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> my-sinatra-user</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Chỉ định thư mục riêng</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /home/my-sinatra-user</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nb>echo</span> <span class=s1>&#39;require &#34;sinatra&#34;; run Sinatra::Application.run!&#39;</span> &gt; config.ru<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Các câu lệnh sẽ chạy với quyền của user my-sinatra-user</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> rackup<span class=err>
</span></span></span></code></pre></div><ul><li>Mặc định container run với quyền root.</li><li>Container của chúng ta sẽ tạo ra một process chạy với quyền root trong Linux kernel, điều này có thể gây ra lỗ hổng bảo mật, cho phép attackers thoát khỏi container và thực hiện quyền root trên thiết bị của chúng ta.</li></ul><a href=#-vi-sử-dụng--chown-khi-run-copy-hoặc-add><h2 id=-vi-sử-dụng--chown-khi-run-copy-hoặc-add><span class=hanchor arialabel=Anchor># </span>🌿 VI. Sử dụng -chown khi run COPY hoặc ADD</h2></a><ul><li>🌱 Bad</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Tạo user riêng để chạy container</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> adduser -D my-sinatra-user<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Chỉ định User thực hiện các câu lệnh RUN, CMD hoặc ENTRYPOINT ở dưới</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> my-sinatra-user</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Chỉ định thư mục riêng</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /home/my-sinatra-user</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># File copy sẽ thuộc sở hữu của root user</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> Gemfile Gemfile.lock ./<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> bundle install<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> rackup<span class=err>
</span></span></span></code></pre></div><ul><li>🌱 Good</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Tạo user riêng để chạy container</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> adduser -D my-sinatra-user<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Chỉ định User thực hiện các câu lệnh RUN, CMD hoặc ENTRYPOINT ở dưới</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> my-sinatra-user</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Chỉ định thư mục riêng</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /home/my-sinatra-user</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># File copy sẽ thuộc sở hữu của my-sinatra-user user</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --chown<span class=o>=</span>my-sinatra-user Gemfile Gemfile.lock ./<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> bundle install<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> rackup<span class=err>
</span></span></span></code></pre></div><ul><li><code>USER</code> chỉ chỉ định user thực hiện <code>RUN</code>, <code>CMD</code> hoặc <code>ENTRYPOINT</code>. Còn với <code>COPY</code> và <code>ADD</code> chúng ta cần sử dụng <code>--chown</code>.</li></ul><a href=#-vii-tránh-làm-lộ-thông-tin-nhạy-cảm-trong-dockerfile><h2 id=-vii-tránh-làm-lộ-thông-tin-nhạy-cảm-trong-dockerfile><span class=hanchor arialabel=Anchor># </span>🌿 VII. Tránh làm lộ thông tin nhạy cảm trong Dockerfile</h2></a><ul><li>🌱 Bad</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> DB_PASSWORD <span class=s2>&#34;real password&#34;</span><span class=err>
</span></span></span></code></pre></div><ul><li>Các thông tin như trên không bao giờ được hiện diện trong Dockerfile của chúng ta dưới dạng text thô. Thay vào đó, chúng ta có thể sử dụng thông qua những cách sau:<ul><li>Lệnh <code>ARG</code> và truyền giá trị thông qua flag <code>--build-arg</code> khi run.</li><li>Biến môi trường.</li></ul></li></ul><blockquote class=warning-callout><p>Lưu ý
Hai cách trên vẫn có rủi ro vì các giá trị thô sẽ vẫn được ghi lại trong lịch sử build.</p></blockquote><a href=#-viii-xóa-luôn-những-thông-tin-nhạy-cảm-sử-dụng-để-build><h2 id=-viii-xóa-luôn-những-thông-tin-nhạy-cảm-sử-dụng-để-build><span class=hanchor arialabel=Anchor># </span>🌿 VIII. Xóa luôn những thông tin nhạy cảm sử dụng để build</h2></a><ul><li>🌱 Bad</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> PRIVATE_SSH_KEY<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Bước này sẽ lưu lại PRIVATE_SSH_KEY</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>PRIVATE_SSH_KEY</span><span class=si>}</span><span class=s2>&#34;</span> &gt; /root/.ssh/id_rsa<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Đến bước này vẫn sẽ còn giá trị của PRIVATE_SSH_KEY</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> bundle install<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> rm /root/.ssh/id_rsa<span class=err>
</span></span></span></code></pre></div><ul><li>🌱 Good</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> PRIVATE_SSH_KEY<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>PRIVATE_SSH_KEY</span><span class=si>}</span><span class=s2>&#34;</span> &gt; /root/.ssh/id_rsa <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  bundle install <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  rm /root/.ssh/id_rsa<span class=err>
</span></span></span></code></pre></div><ul><li>Nếu có ai truy cập được vào lịch sử build thì có thể lấy được giá trị của PRIVATE_SSH_KEY. Chúng ta nên xóa luôn trong cùng một step để tránh trường hợp trên.</li></ul><a href=#-ix-tối-ưu-size-của-base-image-nếu-có-thể><h2 id=-ix-tối-ưu-size-của-base-image-nếu-có-thể><span class=hanchor arialabel=Anchor># </span>🌿 IX. Tối ưu size của base image nếu có thể</h2></a><ul><li>🌱 Bad</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> ruby -e <span class=s2>&#34;puts 1 + 2&#34;</span><span class=err>
</span></span></span></code></pre></div><ul><li>🌱 Good</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ruby:3.1.2-alpine</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> ruby -e <span class=s2>&#34;puts 1 + 2&#34;</span><span class=err>
</span></span></span></code></pre></div><ul><li>Base Image có nhiều version(chủ yếu khác nhau về base OS), chúng ta nên lựa chọn phù hợp với nhu cầu sử dụng. Mọi người có thể xem thêm ở <a href=/50-til/51-Code/51.09-Docker/What-is-mean-the-tag-suffix-of-an-image-on-docker-hub rel=noopener class=internal-link data-src=/50-til/51-Code/51.09-Docker/What-is-mean-the-tag-suffix-of-an-image-on-docker-hub>đây</a></li><li>Khi lựa chọn Image base từ OS thu gọn, cần để ý:<ul><li>Phải có package manager và các gói có sẵn.</li><li>Xem OS đó sử dụng Shell gì.</li><li>Tránh các môi trường thử nghiệm, dễ gây rủi ro về mặt bảo mật hoặc tính ổn định.</li></ul></li></ul><div id=modalShowImage class=modal><span class=close>&#215;</span>
<img class=modal-content id=modal-content-img></div><script>$(".myImg").on("click",function(){$("#modalShowImage").css("display","block"),$("#modal-content-img").attr("src",this.src),$("body").addClass("modal-open")}),$("#modalShowImage").on("hidden.bs.modal",function(){$("body").removeClass("modal-open")}),$("#modalShowImage").on("click",".close",function(){$("#modalShowImage").css("display","none"),$("body").removeClass("modal-open")})</script></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://anhhn.netlify.app/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by anhnh using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://anhhn.netlify.app/>Home</a></li><li><a href="https://www.facebook.com/profile.php?id=100026527598703">Facebook</a></li><li><a href=https://github.com/anhnh-3008>Github</a></li></ul></footer></div></div></body></html>